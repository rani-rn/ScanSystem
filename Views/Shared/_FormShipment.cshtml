<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .container-form {
        max-width: 800px;
        margin: auto;
        padding: 20px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 50px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-row {
        display: flex;
        gap: 10px;
    }

    .stats {
        display: flex;
        justify-content: space-between;
        text-align: center;
        margin: 20px 0;
    }

    .stat-box {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background: #f9f9f9;
    }

    .stats-box {
        background: yellow;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }
</style>

<div class="container-form">
    <div class="form-group">
        <label for="deliveryOrder">Delivery Order</label>
        <select class="form-control" id="deliveryOrder">
            <option value=""></option>
        </select>
    </div>
    <div class="form-row">
        <div class="form-group col-md-6">
            <label for="model">Model</label>
            <input type="text" class="form-control" id="model" placeholder="Model" readonly>
        </div>
        <div class="form-group col-md-6">
            <label for="destination">Destination</label>
            <input type="text" class="form-control" id="destination" placeholder="Destination" readonly>
        </div>

    </div>
    <div class="form-group">
        <label for="contNo">Container</label>
        <input type="text" class="form-control" id="contNo" placeholder="Container" readonly>
    </div>
    <div class="form-group">
        <input type="text" class="form-control" id="serialNumber" placeholder="Serial Number" autofocus>
    </div>
    <div class="stats">
        <div class="stat-box">
            <h4>Demand</h4>
            <p id="planQty">0</p>
        </div>
        <div class="stat-box stats-box">
            <h4>Actual</h4>
            <p id="actualQty">0</p>
        </div>
        <div class="stat-box">
            <h4>Countdown</h4>
            <p id="countdown">0</p>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Select</th>
                    <th>Serial Number</th>
                </tr>
            </thead>
            <tbody id="dataTable"></tbody>
        </table>
    </div>
    <div class="buttons">
        <button id="confirmBtn" class="btn btn-primary" disabled>Confirm</button>
        <button id="resetBtn" class="btn btn-danger">Reset List</button>
    </div>
</div>
<script>
    $(document).ready(function () {
        const elements = {
            deliveryOrderSelect: $("#deliveryOrder"),
            serialNumberInput: $("#serialNumber"),
            dataTable: $("#dataTable"),
            confirmBtn: $("#confirmBtn"),
            resetBtn: $("#resetBtn"),
            planQty: $("#planQty"),
            actualQty: $("#actualQty"),
            countdown: $("#countdown"),
        };

        const scannedSerialNumbers = new Set();

        init();

        function init() {
            loadDeliveryOrders();
            elements.serialNumberInput.prop("disabled", true);

            elements.deliveryOrderSelect.change(handleDeliveryOrderChange);
            elements.serialNumberInput.on("change", processScan);
            elements.confirmBtn.click(confirmAllScans);
            elements.resetBtn.click(resetScanList);
        }

        function loadDeliveryOrders() {
            fetch("/api/deliveryorder")
                .then(response => response.json())
                .then(data => {
                    elements.deliveryOrderSelect.empty().append('<option value="">Select</option>');
                    data.forEach(item => {
                        elements.deliveryOrderSelect.append(
                            `<option value="${item.doid}" data-donumber="${item.donumber}">${item.donumber}</option>`
                        );
                    });
                })
                .catch(() => showAlert("Error", "Failed to load delivery orders", "error"));
        }

        function handleDeliveryOrderChange() {
            const actual = parseInt(elements.actualQty.text());

            if (actual > 0) {
                Swal.fire({
                    title: "Warning",
                    text: "Items you have scanned will disappear, are you sure you want to change delivery order?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Yes",
                    cancelButtonText: "Cancel"
                }).then((result) => {
                    if (result.isConfirmed) {
                        clearDeliveryOrderDetails();
                        const doId = elements.deliveryOrderSelect.val();
                        if (doId) {
                            loadDeliveryOrderDetails(doId);
                        }
                    } else {
                        elements.deliveryOrderSelect.val(elements.deliveryOrderSelect.data("previous"));
                    }
                });
            } else {
                clearDeliveryOrderDetails();
                const doId = elements.deliveryOrderSelect.val();
                if (doId) {
                    loadDeliveryOrderDetails(doId);
                }
            }

            elements.deliveryOrderSelect.data("previous", elements.deliveryOrderSelect.val());
        }

        function loadDeliveryOrderDetails(doId) {
            fetch(`/api/deliveryorder/${doId}`)
                .then(response => response.json())
                .then(data => {
                    $("#model").val(data.modelName);
                    $("#destination").val(data.destination);
                    $("#contNo").val(data.contNo);
                    updateStats(data.qty, 0);
                    elements.serialNumberInput.prop("disabled", false);
                })
                .catch(() => showAlert("Error", "Failed to load Delivery Order details", "error"));
        }

        function clearDeliveryOrderDetails() {
            $("#model, #destination, #contNo").val("");
            updateStats(0, 0);
            elements.dataTable.empty();
            scannedSerialNumbers.clear();
            elements.confirmBtn.prop("disabled", true);
            elements.serialNumberInput.prop("disabled", true);
        }

        function processScan() {
            const input = elements.serialNumberInput.val().trim();
            if (!input) return;
            isRFID(input) ? validateRFID(input) : validateSerialNumber(input);
        }

        function isRFID(input) {
            return input.startsWith("TAG");
        }

        function validateSerialNumber(serialNumber) {
            if (scannedSerialNumbers.has(serialNumber)) {
                showAlert("Error", "Serial Number has been scanned!", "warning");
                resetInput();
                return;
            }

            fetch(`/api/deliveryorder/validate/${serialNumber}`)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        showAlert("Error", "Serial Number not found!", "error");
                        resetInput();
                        return;
                    }

                    const deliveryOrderModel = $("#model").val();
                    if (data[0].model !== deliveryOrderModel) {
                        showAlert("Error", "Model tidak sesuai dengan Delivery Order!", "error");
                        resetInput();
                        return;
                    }

                    data.forEach(item => addSerialNumber(item.serialNumber));
                    resetInput();
                })
                .catch(() => showAlert("Error", "Failed to validate serial number", "error"));
        }

        function addSerialNumber(serial) {
            if (!serial || scannedSerialNumbers.has(serial)) return;

            const planned = parseInt(elements.planQty.text());
            const actual = scannedSerialNumbers.size;

            if (actual >= planned) {
                showAlert("Warning", "Jumlah sudah memenuhi permintaan!", "warning");
                resetInput();
                return;
            }

            scannedSerialNumbers.add(serial);
            elements.dataTable.append(`
        <tr>
            <td><input type="checkbox" class="row-checkbox"></td>
            <td>${serial}</td>
        </tr>
    `);

            updateQuantities(1);
            updateStats(planned, scannedSerialNumbers.size);
        }

        function updateQuantities(newSerials = 0) {
            const rowCount = elements.dataTable.find("tr").length;
            const planned = parseInt(elements.planQty.text());

            if (rowCount > planned) {
                showAlert("Warning", "Jumlah sudah memenuhi permintaan!", "warning");
                return;
            }

            updateStats(planned, rowCount);
        }

        function updateStats(planned, actual) {
            elements.planQty.text(planned);
            elements.actualQty.text(actual);
            elements.countdown.text(planned - actual);

            elements.confirmBtn.prop("disabled", actual === 0);
        }

        function confirmAllScans() {
            const serialNumbers = Array.from(scannedSerialNumbers);
            const doId = elements.deliveryOrderSelect.val();

            if (!doId || serialNumbers.length === 0) {
                showAlert("Error", "No items to confirm!", "error");
                return;
            }

            fetch(`/api/deliveryorder/move-to-mastertable/${doId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(serialNumbers),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showAlert("Error", data.error, "error");
                        return;
                    }

                    showAlert("Success", "Items moved to MasterTable!", "success");
                    scannedSerialNumbers.clear();
                    elements.dataTable.empty();

                    loadDeliveryOrderDetails(doId);
                })
                .catch(() => showAlert("Error", "Failed to confirm scans!", "error"));
        }


        function resetScanList() {
            const selectedCheckboxes = elements.dataTable.find(".row-checkbox:checked");

            if (selectedCheckboxes.length > 0) {
                showConfirmation("Are you sure?", "Do you want to delete the selected scans?", () => {
                    selectedCheckboxes.each(function () {
                        const row = $(this).closest("tr");
                        scannedSerialNumbers.delete(row.find("td:nth-child(2)").text());
                        row.remove();
                    });
                    updateQuantities();
                    showAlert("Deleted!", "Selected scans have been deleted.", "success");
                });
            } else {
                showConfirmation("Are you sure?", "Do you want to reset the entire scan list?", () => {
                    scannedSerialNumbers.clear();
                    elements.dataTable.empty();
                    updateQuantities();
                    showAlert("Reset!", "All scans have been reset.", "success");
                });
            }
        }

        function showAlert(title, text, icon) {
            Swal.fire({ title, text, icon });
        }

        function showConfirmation(title, text, onConfirm) {
            Swal.fire({
                title, text, icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes",
                cancelButtonText: "No"
            }).then(result => {
                if (result.isConfirmed) onConfirm();
            });
        }

        function resetInput() {
            elements.serialNumberInput.val("").focus();
        }
    });
</script>