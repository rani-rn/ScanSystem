@{
    ViewData["Title"] = "Create Shipping";
}

<h2 class="text-center mt-3">Create New Shipping</h2>

<div class="container-sm" style="max-width: 600px;">
    <form method="post" id="shipping-form">
        <div class="mb-2">
            <label for="soNumber" class="form-label">SO Number</label>
            <input type="text" class="form-control form-control-sm" id="soNumber" name="soNumber" required>
        </div>
        <div class="mb-2">
            <label for="destination" class="form-label">Destination</label>
            <input type="text" class="form-control form-control-sm" id="destination" name="destination" required>
        </div>
        <div class="mb-2">
            <label for="date" class="form-label">Date</label>
            <input type="date" class="form-control form-control-sm" id="date" name="date" required>
        </div>

        <fieldset id="do-form" disabled>
            <h5 class="mt-3">Delivery Order Details</h5>
            <div class="row">
                <div class="col-md-4 mb-2">
                    <label for="doNumber" class="form-label">DO Number</label>
                    <input type="text" class="form-control form-control-sm" id="doNumber">
                </div>
                <div class="col-md-4 mb-2">
                    <label for="model" class="form-label">Model</label>
                    <select id="model" class="form-control form-control-sm" name="ModelId" required>
                        <option value="">Select Model</option>
                        @foreach (var item in ViewBag.ListModel)
                        {
                            <option value="@item.ModelId">@item.ModelName</option>
                        }
                    </select>
                </div>

                <div class="col-md-4 mb-2">
                    <label for="qty" class="form-label">Quantity</label>
                    <input type="number" class="form-control form-control-sm" id="qty">
                </div>
            </div>
            <button type="button" class="btn btn-info btn-sm w-100" id="add-do">Add DO</button>
        </fieldset>
    </form>

    <h5 class="mt-3">DO Records</h5>
    <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
        <table class="table table-bordered table-striped table-sm">
            <thead class="table-dark">
                <tr>
                    <th>Select</th>
                    <th>DO Number</th>
                    <th>Model</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody id="do-table-body">

            </tbody>
        </table>
    </div>

    <div class="d-grid gap-2 mt-3">
        <button type="button" class="btn btn-danger btn-sm" id="reset-list">Reset</button>
        <button type="button" class="btn btn-success btn-sm" id="save">Save</button>
        <button type="button" class="btn btn-secondary btn-sm" id="cancel">Cancel</button>
    </div>
</div>
<script>
    document.getElementById("soNumber").addEventListener("input", function () {
        let doForm = document.getElementById("do-form");
        doForm.disabled = this.value.trim() === "";
    });

    function updateButtonState() {
        let tableBody = document.getElementById("do-table-body");
        let hasData = tableBody.children.length > 0 && tableBody.children[0].textContent !== "No Data";

        document.getElementById("reset-list").disabled = !hasData;
        document.getElementById("save").disabled = !hasData;
    }

    document.getElementById("add-do").addEventListener("click", async function () {
        let doNumber = document.getElementById("doNumber").value.trim();
        let model = document.getElementById("model").value;
        let qty = document.getElementById("qty").value;

        if (!doNumber || !model || !qty) {
            alert("Please fill all DO fields!");
            return;
        }

        let tableRows = document.querySelectorAll("#do-table-body tr");
        for (let row of tableRows) {
            if (row.cells[1]?.textContent === doNumber) {
                alert("DO Number already exists in the list!");
                return;
            }
        }

        let response = await fetch(`/Shipping/CheckDONumber?doNumber=${doNumber}`);
        let data = await response.json();
        if (data.exists) {
            alert("DO Number already exists in the database!");
            return;
        }

        let tableBody = document.getElementById("do-table-body");
        if (tableBody.children.length === 1 && tableBody.children[0].textContent === "No Data") {
            tableBody.innerHTML = "";
        }

        let newRow = document.createElement("tr");
        newRow.innerHTML = `
        <td class="text-center"><input type="checkbox" class="delete-checkbox"></td>
        <td>${doNumber}</td>
        <td>${model}</td>
        <td>${qty}</td>
    `;

        newRow.addEventListener("click", function (e) {
            if (e.target.tagName !== "INPUT") {
                document.getElementById("doNumber").value = newRow.cells[1].textContent;
                document.getElementById("model").value = newRow.cells[2].textContent;
                document.getElementById("qty").value = newRow.cells[3].textContent;
            }
        });

        tableBody.appendChild(newRow);
        document.getElementById("doNumber").value = "";
        document.getElementById("model").value = "";
        document.getElementById("qty").value = "";

        updateButtonState();
    });

    document.getElementById("reset-list").addEventListener("click", function () {
        if (!confirm("Are you sure you want to reset the DO list?")) {
            return;
        }

        let checkboxes = document.querySelectorAll(".delete-checkbox:checked");
        checkboxes.forEach(checkbox => checkbox.closest("tr").remove());

        let tableBody = document.getElementById("do-table-body");
        if (tableBody.children.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center">No Data</td></tr>`;
        }

        updateButtonState();
    });

    document.getElementById("save").addEventListener("click", function () {
        alert("Data saved successfully!");
    });

    document.getElementById("cancel").addEventListener("click", function () {
        document.getElementById("shipping-form").reset();
        document.getElementById("do-table-body").innerHTML = `<tr><td colspan="4" class="text-center">No Data</td></tr>`;
        document.getElementById("do-form").disabled = true;

        updateButtonState();
    });

    updateButtonState();


</script>
